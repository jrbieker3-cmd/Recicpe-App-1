<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8" />
  <title>Recipe App</title>
<!-- ‚úÖ Load Firebase libraries first -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  };
<style>

/* -------------------- Base Styles -------------------- */
body {
  font-family: sans-serif;
  margin: 0;
  padding: 0;
  background: #f5f5f5;
  color: #222;
}

.hidden {
  display: none;
}

.overlay {
  padding: 20px;
  margin: 20px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

/* -------------------- Navigation -------------------- */
.responsive-nav {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background-color: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-around;
  padding: 10px 0;
  z-index: 1000;
}

.responsive-nav button {
  flex: 1;
  font-size: 1rem;
  padding: 10px;
  border: none;
  background: none;
  cursor: pointer;
  color: #333;
}

.responsive-nav button:hover {
  background-color: #f0f0f0;
}

/* -------------------- Planner Layout -------------------- */
.planner-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  flex-wrap: wrap;
  gap: 20px;
}

.planner-title {
  flex: 1;
}

.planner-title h2 {
  margin: 0;
  font-size: 1.8rem;
  text-align: left;
}

.planner-controls {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
}

.planner-controls input {
  flex: 1;
  padding: 8px;
  font-size: 1rem;
}

/* -------------------- Planner Grid -------------------- */
.planner-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 10px;
  margin-top: 20px;
}

.planner-label {
  text-align: center;
  font-weight: bold;
}

.planner-cell {
  background: #fff;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.planner-thumb {
  width: 100%;
  height: 100px;
  object-fit: cover;
  border-radius: 6px;
  margin-top: 5px;
  cursor: pointer;
}

.side-wrapper {
  display: flex;
  align-items: center;
  margin-top: 4px;
}

.side-add,
.side-remove {
  font-size: 1rem;
  padding: 2px 6px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
}

.side-add {
  background-color: #eee;
}

.side-remove {
  background-color: #fdd;
  margin-left: 6px;
}

.side-add-rect {
  width: 100%;
  padding: 10px 16px;
  font-size: 0.875rem;
  border: 2px solid #b39ddb;
  color: #b39ddb;
  background-color: transparent;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease, color 0.2s ease;
  margin-top: 8px;
  box-sizing: border-box;
}

/* -------------------- Buttons -------------------- */
button {
  background-color: white;
  color: #b39ddb;
  border: 2px solid #b39ddb;
  padding: 10px 16px;
  font-size: 1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease, color 0.2s ease;
  display: flex;
  justify-content: center;
  align-items: center;
}

button:hover {
  background-color: #b39ddb;
  color: white;
}

/* -------------------- Grocery Page -------------------- */
#groceryPage {
  position: relative;
}

#exclusionSidebar {
  transition: all 0.3s ease;
}

/* -------------------- Gallery -------------------- */
#gallery {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  justify-content: center;
  padding: 20px;
}

#gallery .planner-cell {
  width: 200px;
  height: 300px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  box-sizing: border-box;
  border-radius: 6px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  background: #fff;
  transition: transform 0.2s ease;
}

#gallery .planner-cell:hover {
  transform: scale(1.02);
}

#gallery .planner-thumb {
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 6px;
}

/* -------------------- Recipe Detail -------------------- */
.recipe-detail-container {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 30px;
  align-items: start;
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
  box-sizing: border-box;
}

.recipe-left {
  overflow: hidden;
}

.recipe-right {
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

.recipe-right img {
  width: 100%;
  max-width: 320px;
  border-radius: 12px;
  height: auto;
  object-fit: cover;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

#ingredientChecklist,
#instructionList,
#notesList {
  margin: 0 0 20px 0;
  padding-left: 20px;
  line-height: 1.6;
}

#ingredientChecklist {
  list-style: none;
  padding-left: 0;
}

#ingredientChecklist li {
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

#ingredientChecklist input[type="checkbox"] {
  transform: scale(1.2);
  margin-right: 8px;
}

.strikethrough {
  text-decoration: line-through;
  opacity: 0.6;
  transition: opacity 0.2s ease, text-decoration 0.2s ease;
}

/* -------------------- Tablet Styles -------------------- */
@media (max-width: 768px) {
  .responsive-nav {
    top: auto;
    bottom: 0;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  }

  .planner-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .planner-thumb {
    height: 80px;
  }

  .overlay {
    margin: 10px;
    padding: 10px;
  }

  input, select, button, textarea {
    font-size: 1rem;
    padding: 10px;
    margin-bottom: 10px;
    width: 100%;
    box-sizing: border-box;
  }

  .recipe-detail-container {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .recipe-right img {
    max-width: 100%;
    width: 100%;
  }

  #ingredientChecklist,
  #instructionList,
  #notesList {
    padding-left: 0;
  }
}

/* -------------------- Mobile Styles -------------------- */
@media (max-width: 480px) {
  .planner-label {
    display: none;
  }

  .planner-grid {
    grid-template-columns: 1fr;
  }

  .planner-cell {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    padding: 10px;
  }

  .planner-cell input,
  .planner-cell select,
  .planner-cell button {
    width: 100%;
    margin-bottom: 6px;
  }

  .planner-thumb {
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 8px;
  }

  .side-wrapper {
    flex-direction: column;
    align-items: flex-start;
  }

  .mobile-day-label {
    display: block;
    font-weight: bold;
    text-align: center;
    margin-bottom: 6px;
  }

  #groceryList li {
    flex-direction: column;
    align-items: flex-start;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }

  #groceryList div {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    flex-wrap: wrap; /* ‚úÖ allow wrapping on small screens */
  }

  #groceryList input[type="text"] {
    flex: 1;
    min-width: 160px;
    font-size: 1rem;
    padding: 6px 0;
    border: none;
    background: transparent;
  }

  #groceryList input[type="checkbox"] {
    transform: scale(1.2);
    margin: 0;
  }

  #groceryList select {
    width: 100%;
    font-size: 1rem;
    padding: 6px;
    margin-top: 6px;
  }
}

</style>



<body>
<body>
  <!-- ‚úÖ Navigation -->
  <div class="responsive-nav">
    <button onclick="showPage('plannerPage')">Planner</button>
    <button onclick="showPage('groceryPage')">Grocery List</button>
    <button onclick="showPage('galleryPage')">Gallery</button>
    <button onclick="showPage('conversionPage')">Conversions</button>
    <button onclick="showPage('exclusionPage')">Exclusions</button>
  </div>

  <!-- ‚úÖ Recipe Detail Page -->
  <div id="recipeDetailPage" class="hidden" style="padding: 60px;">
    <h2 id="recipeDetailHeader" style="text-align: center;"></h2>
    <div id="servingSizeDisplay" style="margin-top: 10px; font-style: italic;"></div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
      <button onclick="showPage('plannerPage')" style="font-size: 1rem;">‚Üê Back to Planner</button>
      <div style="display: flex; gap: 10px;">
        <button onclick="editRecipe()" style="display: flex; align-items: center; gap: 6px; font-size: 1rem;">Edit</button>
        <button onclick="confirmDeleteRecipe()" style="display: flex; align-items: center; gap: 6px; font-size: 1rem;">Delete</button>
      </div>
    </div>

    <h3 id="recipeNameDisplay" style="text-align: center; margin: 0 0 20px 0; font-weight: normal;"></h3>

    <div style="display: flex; gap: 20px;">
      <ul id="ingredientChecklist" style="flex: 1;"></ul>
      <img id="detailImage" style="width: 300px; border-radius: 8px;" />
    </div>

    <h3>Instructions</h3>
    <ol id="instructionList"></ol>

    <h3>Notes</h3>
    <ol id="notesList"></ol>
  </div>

  <!-- ‚úÖ Planner Page -->
  <div id="plannerPage">
    <div class="planner-header">
      <div class="planner-title"><h2>Meal Planner</h2></div>
      <div class="planner-controls">
        <button onclick="startNewRecipe()">Add Recipe</button>
      </div>
    </div>

    <label>Season:</label>
    <select id="seasonSelect" onchange="renderPlanner()">
      <option value="Spring/Summer">Spring/Summer</option>
      <option value="Fall/Winter">Fall/Winter</option>
    </select>

    <label>Week:</label>
    <select id="weekSelect" onchange="renderPlanner()">
      <option value="1">Week 1</option>
      <option value="2">Week 2</option>
      <option value="3">Week 3</option>
      <option value="4">Week 4</option>
      <option value="5">Custom</option>
    </select>

    <label>View Mode:</label>
    <select id="plannerMode" onchange="renderPlanner()">
      <option value="week">Week View</option>
      <option value="month">Month View</option>
    </select>

    <div id="plannerLabels" class="planner-grid"></div>
    <div id="plannerPreview" class="planner-grid"></div>
  </div>

  <!-- ‚úÖ Grocery Page -->
  <div id="groceryPage" class="hidden" style="padding: 20px; position: relative;">
    <h2>Grocery List</h2>

    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
      <button onclick="generateGroceryList()">Generate Grocery List</button>
      <button onclick="clearGroceryList()">Clear List</button>
      <button onclick="toggleExclusionSidebar()">Toggle Exclusion List</button>
      <button onclick="toggleCategoryDropdown()">Toggle Category Dropdown</button>
    </div>

    <ul id="groceryList"></ul>

    <!-- Exclusion Sidebar -->
    <div id="exclusionSidebar"
         style="position: absolute; top: 60px; right: 0; width: 280px; background: #fff;
                box-shadow: -2px 0 6px rgba(0,0,0,0.1); padding: 16px;
                border-left: 1px solid #ccc; display: none; z-index: 100;">
      <h3 style="margin-top: 0;">Do Not Auto-Add</h3>
      <ul id="exclusionListSidebar"></ul>
      <input id="newExclusionSidebarInput" placeholder="Add item to exclude" />
      <button onclick="addToExclusionSidebar()">Add</button>
    </div>
  </div>

  <!-- ‚úÖ Gallery Page -->
  <div id="galleryPage" class="hidden" style="padding: 20px;">
    <h2>Recipe Gallery</h2>

    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
      <div style="position: relative; width: 100%; max-width: 300px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
             class="bi bi-search" viewBox="0 0 16 16"
             style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%);
                    pointer-events: none; color: #888;">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85
                   a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12
                   6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
        </svg>
        <input type="text" id="searchInput" placeholder="Search recipes..."
               oninput="renderGallery()"
               style="width: 100%; padding: 8px 8px 8px 36px; border: 1px solid #ccc;
                      border-radius: 6px; font-size: 1rem;" />
      </div>
    </div>

    <div id="gallery"></div>
  </div>

  <!-- ‚úÖ Add Recipe Page -->
  <div id="addRecipePage" class="hidden" style="padding: 20px;">
    <h3>Import Recipe from Website</h3>
    <input id="recipeUrlInput" placeholder="Paste recipe URL here" style="width:80%;" />
    <button onclick="fetchRecipe()">Import Recipe</button>

    <h2>Add New Recipe</h2>
    <label>Name: <input id="newRecipeName" /></label><br>
    <label>Description: <input id="newRecipeDesc" /></label><br>
    <label>Cook Time (min): <input id="newRecipeTime" type="number" /></label><br>
    <label>Image URL (optional): <input id="newRecipeImage" /></label><br>
    <label>Serving Size: <input id="newRecipeServings" type="number" min="1" step="1" /></label><br>

    <label>Season:
      <select id="newRecipeSeason">
        <option value="Spring/Summer">Spring/Summer</option>
        <option value="Fall/Winter">Fall/Winter</option>
        <option value="Year-Round">Year-Round</option>
      </select>
    </label><br>

    <h3>Ingredients</h3>
    <div id="ingredientList"></div>
    <button onclick="addIngredientRow()">+ Add Ingredient</button>

    <h3>Instructions</h3>
    <textarea id="newRecipeInstructions" rows="4" cols="50" placeholder="One step per line"></textarea>

    <h3>Notes</h3>
    <textarea id="newRecipeNotes" rows="4" cols="50" placeholder="One note per line"></textarea>

    <br><br>
    <button onclick="saveNewRecipe()">Save Recipe</button>
    <button onclick="showPage('plannerPage')">‚Üê Back to Planner</button>
  </div>

  <!-- ‚úÖ Conversion Page -->
  <div id="conversionPage" class="hidden" style="padding: 20px;">
    <h2>Edit Unit Conversions</h2>
    <table style="width:100%; border-collapse: collapse; margin-bottom: 16px;">
      <thead>
        <tr>
          <th style="text-align:left;">From Unit</th>
          <th style="text-align:left;">To Unit</th>
          <th style="text-align:left;">Factor</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="conversionTableBody"></tbody>
    </table>

    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <input id="newFromUnit" placeholder="From (e.g. tbsp)" />
      <input id="newToUnit" placeholder="To (e.g. tsp)" />
      <input id="newFactor" type="number" step="0.01" placeholder="Factor (e.g. 3)" />
      <button onclick="addConversion()">Add Conversion</button>
    </div>
  </div>

<!-- ‚úÖ Then initialize Firebase -->
<script>
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID
};


  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  window.db = db; // ‚úÖ Make Firestore globally accessible

    // ‚úÖ Initialize variables early to prevent ReferenceError
let plannerSelections = {}; // ‚úÖ Declare once globally

db.collection("plannerSelections").doc("default").get().then(doc => {
  if (doc.exists) {
    plannerSelections = doc.data();
    renderPlanner(); // ‚úÖ Safe to call after loading
  } else {
    plannerSelections = {
      "Spring/Summer": {},
      "Fall/Winter": {},
      "Year-Round": {}
    };
    db.collection("plannerSelections").doc("default").set(plannerSelections);
  }
}).catch(error => {
  console.error("Error loading plannerSelections:", error);
});

    console.log("Firebase initialized successfully");

let recipes = [];

db.collection("recipes").get().then(snapshot => {
  recipes = snapshot.docs.map(doc => doc.data());

  if (recipes.length === 0) {
    recipes = [
      {
        name: "Spaghetti Bolognese",
        image: "https://sagourmetfoodco.com.au/wp-content/uploads/2021/05/SAGFC-004-Spaghetti-Bolognese-700x519.jpg",
        description: "Rich tomato meat sauce over pasta",
        cookTime: 45,
        season: "Spring/Summer",
        ingredients: [
          { name: "Pasta", qty: 1, unit: "box" },
          { name: "Tomato Sauce", qty: 1, unit: "jar" },
          { name: "Ground Beef", qty: 500, unit: "g" },
          { name: "Onion", qty: 1, unit: "pcs" }
        ],
        instructions: [
          "Boil pasta until al dente.",
          "Cook ground beef until browned.",
          "Add tomato sauce and simmer.",
          "Combine with pasta and serve."
        ],
        notes: [
          "Use fresh herbs for better flavor.",
          "Can substitute ground turkey."
        ]
      },
      {
        name: "Lemon Herb Chicken",
        image: "https://www.eatyourselfskinny.com/wp-content/uploads/2024/04/lemon-chicken-2-scaled.jpg",
        description: "Tender chicken with zesty lemon and herbs",
        cookTime: 60,
        season: "Spring/Summer",
        ingredients: [
          { name: "Chicken Thighs", qty: 4, unit: "pcs" },
          { name: "Lemon", qty: 2, unit: "pcs" },
          { name: "Rosemary", qty: 1, unit: "tbsp" },
          { name: "Olive Oil", qty: 1, unit: "tbsp" }
        ],
        instructions: [
          "Marinate chicken with lemon and rosemary.",
          "Sear chicken until golden.",
          "Bake until cooked through.",
          "Serve with pan juices."
        ],
        notes: [
          "Use fresh herbs for better flavor.",
          "Can substitute chicken breasts."
        ]
      }
    ];

    // Save fallback recipes to Firestore
    recipes.forEach(recipe => {
      db.collection("recipes").doc(recipe.name).set(recipe);
    });
  }

  renderPlanner(); // ‚úÖ Now safe to call after recipes are loaded or seeded
}).catch(error => {
  console.error("Error loading recipes:", error);
});


const fallbackImage = "https://developers.elementor.com/docs/assets/img/elementor-placeholder-image.png";

db.collection("plannerSelections").doc("default").get().then(doc => {
  if (doc.exists) {
    plannerSelections = doc.data();
    renderPlanner(); // or whatever uses plannerSelections
  } else {
    plannerSelections = {
      "Spring/Summer": {},
      "Fall/Winter": {},
      "Year-Round": {}
    };
    db.collection("plannerSelections").doc("default").set(plannerSelections);
  }
}).catch(error => {
  console.error("Error loading plannerSelections:", error);
});



// Structure: { "Spring/Summer": { W1D1: {...} }, "Fall/Winter": { W1D1: {...} }, "Year-Round": { W1D1: {...} } }
let groceryList = [];
const categoryMap = {
  "bread": "Bread",
  "flat bread": "Bread",
  "wonton": "Bread",
  "cilantro": "Produce",
  "green onion": "Produce",
  "ginger": "Produce",
  "garlic": "Produce",
  "turmeric": "Produce",
  "mint": "Produce",
  "basil": "Produce",
  "parsley": "Produce",
  "dill": "Produce",
  "rosemary": "Produce",
  "thyme": "Produce",
  "sage": "Produce",
  "eggs": "Dairy",
  "butter": "Dairy",
  "cheese": "Dairy",
  "milk": "Dairy",
  "yogurt": "Dairy",
  "sour cream": "Dairy",
  "turkey": "Deli",
  "chicken": "Meat",
  "beef": "Meat",
  "pork": "Meat",
  "broth": "Soups",
  "soy sauce": "Condiments & Sauces",
  "fish sauce": "Condiments & Sauces",
  "hoisin": "Condiments & Sauces",
  "sriracha": "Condiments & Sauces",
  "rice": "Pasta",
  "noodles": "Pasta",
  "chips": "Crackers & Chips",
  "oil": "Essentials",
  "gochujang": "Other",
  "cornstarch": "Other",
  "granola": "Other",
  "smoothie": "Other",
  "frozen": "Other"
};
let unitConversion = {};

db.collection("settings").doc("unitConversion").get().then(doc => {
  if (doc.exists) {
    unitConversion = doc.data();
  } else {
    unitConversion = {
      tsp: { to: "tsp", factor: 1 },
      tbsp: { to: "tsp", factor: 3 },
      cup: { to: "tsp", factor: 48 },
      oz: { to: "tsp", factor: 6 },
      ml: { to: "tsp", factor: 0.202884 },
      l: { to: "tsp", factor: 202.884 }
    };
    db.collection("settings").doc("unitConversion").set(unitConversion);
  }
});


  // Add more as needed
let exclusionList = [];

db.collection("settings").doc("exclusionList").get().then(doc => {
  if (doc.exists) {
    exclusionList = doc.data().items || [];
  } else {
    exclusionList = ["Milk", "Egg", "Salt", "Pepper", "Paprika", "Cumin", "Trash"];
    db.collection("settings").doc("exclusionList").set({ items: exclusionList });
  }
});

let showCategoryDropdown = false;

let customCategoryMap = {};

db.collection("settings").doc("customCategoryMap").get().then(doc => {
  if (doc.exists) {
    customCategoryMap = doc.data();
  }
});


function showPage(id) {
  const pages = [
    "plannerPage",
    "groceryPage",
    "galleryPage",
    "recipeDetailPage",
    "addRecipePage",
    "exclusionPage",
    "conversionPage"
  ];

  pages.forEach(p => {
    const el = document.getElementById(p);
    if (el) {
      el.classList.toggle("hidden", p !== id);
    }
  });

  if (id === "exclusionPage") renderExclusionList();
  if (id === "conversionPage") renderConversionTable();
}






function recipeOptions(season) {
  return `<option value="">--None--</option>` +
    recipes
      .filter(r => r.season === season || r.season === "Year-Round")
      .map(r => `<option value="${r.name}">${r.name}</option>`)
      .join("");
}



function addSide(dayId) {
  const container = document.getElementById(`${dayId}-sides`);
  const wrapper = document.createElement("div");
  wrapper.className = "side-wrapper";

  const select = document.createElement("select");
  select.innerHTML = recipeOptions(document.getElementById("seasonSelect").value);
  select.onchange = () => updatePlanner(dayId);

const linkBtn = document.createElement("img");
linkBtn.src = "https://png.pngtree.com/element_our/20190529/ourmid/pngtree-cartoon-link-icon-download-image_1196815.jpg";
linkBtn.alt = "View recipe";
linkBtn.title = "View recipe";
linkBtn.style.width = "20px";
linkBtn.style.height = "20px";
linkBtn.style.marginLeft = "6px";
linkBtn.style.cursor = "pointer";
linkBtn.onclick = () => {
  const recipeName = select.value;
  const recipe = recipes.find(r => r.name === recipeName);
  if (recipe) showRecipeDetail(recipe);
};

  const removeBtn = document.createElement("button");
  removeBtn.textContent = "‚Äì";
  removeBtn.className = "side-remove";
  removeBtn.onclick = () => {
    container.removeChild(wrapper);
    updatePlanner(dayId);
  };

  wrapper.appendChild(select);
  wrapper.appendChild(linkBtn);
  wrapper.appendChild(removeBtn);
  container.appendChild(wrapper);
}
function showRecipeDetail(recipe) {
  showPage("recipeDetailPage");

  // Scroll to top of detail view for better UX
  document.getElementById("recipeDetailPage").scrollIntoView({ behavior: "smooth" });

  // Set image
  const imgEl = document.getElementById("detailImage");
  imgEl.src = recipe.image;
  imgEl.alt = recipe.name;

  // Set recipe name in header
  const headerEl = document.getElementById("recipeDetailHeader");
  if (headerEl) headerEl.textContent = recipe.name;

  // Render ingredient checklist
  const ul = document.getElementById("ingredientChecklist");
  ul.innerHTML = "";

  recipe.ingredients.forEach(({ name, qty, unit }) => {
    const li = document.createElement("li");
    li.style.listStyle = "none";

    const label = document.createElement("label");
    label.style.display = "flex";
    label.style.alignItems = "center";
    label.style.gap = "8px";
    label.style.cursor = "pointer";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.style.transform = "scale(1.4)";

    const span = document.createElement("span");
    span.textContent = `${qty} ${unit ? unit + " " : ""}${name}`; // ‚úÖ cleaner formatting

    checkbox.addEventListener("change", () => {
      span.style.textDecoration = checkbox.checked ? "line-through" : "none";
      span.style.opacity = checkbox.checked ? "0.6" : "1";
    });

    label.appendChild(checkbox);
    label.appendChild(span);
    li.appendChild(label);
    ul.appendChild(li);
  });

  // Render instructions
  const instructionList = document.getElementById("instructionList");
  instructionList.innerHTML = "";
  if (recipe.instructions.length > 0) {
    recipe.instructions.forEach(step => {
      const li = document.createElement("li");
      li.textContent = step;
      instructionList.appendChild(li);
    });
  } else {
    const li = document.createElement("li");
    li.textContent = "No instructions provided.";
    instructionList.appendChild(li);
  }

  // Render notes
  const notesList = document.getElementById("notesList");
  notesList.innerHTML = "";
  if (recipe.notes.length > 0) {
    recipe.notes.forEach(note => {
      const li = document.createElement("li");
      li.textContent = note;
      notesList.appendChild(li);
    });
  } else {
    const li = document.createElement("li");
    li.textContent = "No notes provided.";
    notesList.appendChild(li);
  }

  // Render serving size
  const servingSizeEl = document.getElementById("servingSizeDisplay");
  if (servingSizeEl) {
    servingSizeEl.textContent = recipe.servingSize
      ? `Serves: ${recipe.servingSize}`
      : "Serves: ?";
  }
}

function renderPlanner() {
  const mode = document.getElementById("plannerMode").value;
  const season = document.getElementById("seasonSelect").value;
  const week = parseInt(document.getElementById("weekSelect").value);
  const labelRow = document.getElementById("plannerLabels");
  const cellRow = document.getElementById("plannerPreview");

  labelRow.innerHTML = "";
  cellRow.innerHTML = "";

  if (mode === "week") {
    labelRow.style.display = "grid";
    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

    days.forEach(day => {
      const label = document.createElement("div");
      label.className = "planner-label";
      label.textContent = day;
      labelRow.appendChild(label);
    });

    days.forEach((day, index) => {
  const dayId = `W${week}D${index + 1}`;
  const cell = document.createElement("div");
  cell.className = "planner-cell";
  cell.innerHTML = `
    <div class="mobile-day-label">${day}</div> <!-- ‚úÖ Mobile label -->
    <img id="${dayId}-img" class="planner-thumb" src="" alt="" onclick="handleImageClick('${dayId}')" />
    <div style="display: flex; align-items: center; gap: 6px;">
      <input list="recipeOptions-${dayId}" id="${dayId}-main" onchange="updatePlanner('${dayId}')" />
      <datalist id="recipeOptions-${dayId}">
        ${recipeOptions(season)}
      </datalist>
      <button onclick="clearRecipe('${dayId}')" id="${dayId}-clearBtn" style="display:none; padding: 2px 6px; font-size: 1rem; border: none; background-color: #fdd; border-radius: 50%; cursor: pointer;">√ó</button>
    </div>
    <div id="${dayId}-sides"></div>
    <button onclick="addSide('${dayId}')" class="side-add-rect">+ Add Side</button>
  `;
  cellRow.appendChild(cell);

  const imgEl = document.getElementById(`${dayId}-img`);
  if (imgEl && (!plannerSelections[dayId] || !plannerSelections[dayId].main)) {
    imgEl.src = fallbackImage;
    imgEl.alt = "Add Recipe";
  }
});

  } else {
    labelRow.style.display = "none";

    for (let w = 1; w <= 4; w++) {
      for (let d = 1; d <= 7; d++) {
        const dayId = `W${w}D${d}`;
        const cell = document.createElement("div");
        cell.className = "planner-cell";
        cell.innerHTML = `
          <strong>Day ${dayId}</strong><br>
          Main: <select id="${dayId}-main" onchange="updatePlanner('${dayId}')">
            ${recipeOptions(season)}
          </select>
          <div id="${dayId}-sides"></div>
          <button onclick="addSide('${dayId}')" class="side-add">+</button>
        `;
        cellRow.appendChild(cell);
      }
    }
  }

  restorePlannerSelections();
}

function addIngredientRow() {
  const container = document.getElementById("ingredientList");

  const row = document.createElement("div");
  row.className = "ingredient-row";
  row.style.marginBottom = "6px";
  row.innerHTML = `
    <input placeholder="Ingredient name" class="ingredient-name" style="width:160px;" />
    <input type="number" placeholder="Qty" class="ingredient-qty" style="width:60px;" />
    <input placeholder="Unit (optional)" class="ingredient-unit" style="width:80px;" />
  `;
  container.appendChild(row);
}

function normalizeIngredient(name) {
  const lower = name.toLowerCase().trim();

  // Handle common aliases
  if (lower.includes("yellow onion") || lower.includes("onion (yellow)")) return "Onion";
  if (lower.includes("red onion") || lower.includes("onion (red)")) return "Red Onion";

  // Capitalize each word
  const capitalized = lower
    .split(" ")
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");

  return singularize(capitalized);
}

function singularize(word) {
  // Basic plural rules ‚Äî you can expand this with a library later
  const irregulars = {
    Tomatoes: "Tomato",
    Potatoes: "Potato",
    Leaves: "Leaf",
    Loaves: "Loaf",
    Mice: "Mouse",
    Geese: "Goose",
    Eggs: "Egg",
    Onions: "Onion",
    Berries: "Berry",
    // Add more as needed
  };

  const parts = word.split(" ");
  const last = parts[parts.length - 1];

  if (irregulars[last]) {
    parts[parts.length - 1] = irregulars[last];
  } else if (last.endsWith("ies")) {
    parts[parts.length - 1] = last.slice(0, -3) + "y";
  } else if (last.endsWith("es")) {
    parts[parts.length - 1] = last.slice(0, -2);
  } else if (last.endsWith("s") && last.length > 3) {
    parts[parts.length - 1] = last.slice(0, -1);
  }

  return parts.join(" ");
}


function updatePlanner(dayId) {
  const main = document.querySelector(`#${dayId}-main`)?.value || "";
  const selectedRecipe = recipes.find(r => 
  r.name.trim().toLowerCase() === main.trim().toLowerCase()
);

  const clearBtn = document.getElementById(`${dayId}-clearBtn`);
  if (clearBtn) {
  clearBtn.style.display = selectedRecipe ? "inline-block" : "none";
}

  const imgEl = document.getElementById(`${dayId}-img`);
  if (imgEl) {
    if (selectedRecipe) {
      imgEl.src = selectedRecipe.image;
      imgEl.alt = selectedRecipe.name;
    } else {
      imgEl.src = fallbackImage;
      imgEl.alt = "Add Recipe";
    }
  }

  const sides = Array.from(document.querySelectorAll(`#${dayId}-sides select`)).map(s => s.value);
  const inferredWeek = dayId.startsWith("W") ? parseInt(dayId[1]) : parseInt(document.getElementById("weekSelect").value);
  const season = document.getElementById("seasonSelect").value;

  if (!plannerSelections[season]) plannerSelections[season] = {};
  plannerSelections[season][dayId] = { main, sides, week: inferredWeek };
  db.collection("plannerSelections").doc("default").set(plannerSelections);
}


function restorePlannerSelections() {
  const season = document.getElementById("seasonSelect").value;
  const seasonData = plannerSelections[season] || {};
  Object.entries(seasonData).forEach(([dayId, { main, sides }]) => {
    const mainSelect = document.querySelector(`#${dayId}-main`);
    if (mainSelect) mainSelect.value = main;

    const imgEl = document.getElementById(`${dayId}-img`);
    const selectedRecipe = recipes.find(r => r.name === main);
if (imgEl) {
  if (selectedRecipe) {
    imgEl.src = selectedRecipe.image;
    imgEl.alt = selectedRecipe.name;
  } else {
    imgEl.src = fallbackImage;
    imgEl.alt = "Add Recipe";
  }
}


    const sidesContainer = document.getElementById(`${dayId}-sides`);
    if (sidesContainer && sides.length) {
      sides.forEach(side => {
const wrapper = document.createElement("div");
wrapper.className = "side-wrapper";

const select = document.createElement("select");
select.innerHTML = recipeOptions(document.getElementById("seasonSelect").value);
select.value = side;
select.onchange = () => updatePlanner(dayId);

const linkBtn = document.createElement("button");
linkBtn.innerHTML = "üîó";
linkBtn.style.marginLeft = "6px";
linkBtn.style.border = "none";
linkBtn.style.background = "transparent";
linkBtn.style.cursor = "pointer";
linkBtn.title = "View recipe";
linkBtn.onclick = () => {
  const recipeName = select.value;
  const recipe = recipes.find(r => r.name === recipeName);
  if (recipe) showRecipeDetail(recipe);
};

const removeBtn = document.createElement("button");
removeBtn.textContent = "‚Äì";
removeBtn.className = "side-remove";
removeBtn.onclick = () => {
  sidesContainer.removeChild(wrapper);
  updatePlanner(dayId);
};

wrapper.appendChild(select);
wrapper.appendChild(linkBtn);
wrapper.appendChild(removeBtn);
sidesContainer.appendChild(wrapper);
      });
    }
  });
}

function handleImageClick(dayId) {
  const season = document.getElementById("seasonSelect").value;
  const seasonData = plannerSelections[season] || {};
  const main = seasonData[dayId]?.main;

  if (!main) {
    alert("No recipe is assigned to this day.");
    return;
  }

  const recipe = recipes.find(r => 
    r.name.trim().toLowerCase() === main.trim().toLowerCase()
  );

  if (!recipe) {
    console.error("Recipe not found for:", main);
    alert(`Recipe "${main}" not found in your recipe list.`);
    return;
  }

  showRecipeDetail(recipe);
}




function generateGroceryList() {
  const season = document.getElementById("seasonSelect").value;
  const selectedWeek = parseInt(document.getElementById("weekSelect").value);
  const seasonData = plannerSelections[season] || {};

  // Count recipe appearances
  const recipeCounts = {};
  Object.entries(seasonData).forEach(([dayId, sel]) => {
    const weekMatch = dayId.match(/^W(\d)D\d$/);
    const weekNum = weekMatch ? parseInt(weekMatch[1]) : null;
    if (weekNum !== selectedWeek) return;

    const allRecipes = [sel.main, ...(sel.sides || [])];
    allRecipes.forEach(name => {
      if (!name) return;
      recipeCounts[name] = (recipeCounts[name] || 0) + 1;
    });
  });

  // Build and normalize grocery list
  const rawList = [];
  Object.entries(recipeCounts).forEach(([name, count]) => {
    const recipe = recipes.find(r => r.name === name);
    if (!recipe) return;
    recipe.ingredients.forEach(({ name, qty, unit }) => {
      rawList.push({ name, qty: qty * count, unit });
    });
  });

  // Group and sum ingredients
  const grouped = {};
  rawList.forEach(({ name, qty, unit }) => {
    const normalizedName = normalizeIngredient(name);
    if (exclusionList.includes(normalizedName)) return;

    const baseUnit = unitConversion[unit]?.to || unit;
    const factor = unitConversion[unit]?.factor || 1;
    const normalizedQty = qty * factor;
    const key = `${normalizedName}-${baseUnit}`;

    if (!grouped[key]) grouped[key] = { name: normalizedName, qty: 0, unit: baseUnit };
    grouped[key].qty += normalizedQty;
  });

  groceryList = Object.values(grouped);

  // Categorize items
  const categorized = {};
  groceryList.forEach(item => {
    const category =
      customCategoryMap[item.name] ||
      categoryMap[item.name.toLowerCase()] ||
      "Other";
    if (!categorized[category]) categorized[category] = [];
    categorized[category].push(item);
  });

  window.categorized = categorized;
  renderGroceryList();
}

  function renderGroceryList() {
  const ul = document.getElementById("groceryList");
  ul.innerHTML = "";

  const categories = Object.keys(window.categorized || {}).sort();
  categories.forEach(cat => {
    const header = document.createElement("li");
    header.innerHTML = `<strong>${cat}</strong>`;
    header.style.marginTop = "12px";
    ul.appendChild(header);

    (window.categorized[cat] || []).forEach((item, index) => {
      const li = document.createElement("li");
      li.style.display = "flex";
      li.style.flexDirection = "column";
      li.style.marginBottom = "8px";
      li.style.width = "100%";

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.flexWrap = "wrap"; // ‚úÖ allow wrapping on mobile
      row.style.gap = "10px";
      row.style.width = "100%";

      const { qty: displayQty, unit: displayUnit } = readableUnit(item.qty, item.unit);
      const displayText = `${Math.round(displayQty * 100) / 100} ${displayUnit} ${item.name}`;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.onchange = () => toggleStrike(checkbox);
      checkbox.style.transform = "scale(1.2)";
      checkbox.style.margin = "0";

      const input = document.createElement("input");
      input.type = "text";
      input.value = displayText;
      input.onchange = () => updateConcatenatedItem(index, input.value);
      input.style.border = "none";
      input.style.background = "transparent";
      input.style.fontSize = "1rem";
      input.style.padding = "6px 0";
      input.style.margin = "0";
      input.style.flex = "1";
      input.style.minWidth = "160px"; // ‚úÖ prevent collapse on mobile

      row.appendChild(checkbox);
      row.appendChild(input);
      li.appendChild(row);

      if (showCategoryDropdown) {
        const categorySelect = document.createElement("select");
        const categoryOptions = [
          "Produce", "Dairy", "Deli", "Meat", "Canned", "Soups",
          "Condiments & Sauces", "Pasta", "Crackers & Chips", "Essentials", "Other"
        ];
        categoryOptions.forEach(option => {
          const opt = document.createElement("option");
          opt.value = option;
          opt.textContent = option;
          if (option === cat) opt.selected = true;
          categorySelect.appendChild(opt);
        });
        categorySelect.onchange = () => updateCategory(item.name, categorySelect.value);
        categorySelect.style.marginTop = "6px";
        categorySelect.style.width = "100%";
        li.appendChild(categorySelect);
      }

      ul.appendChild(li);
    });
  });
}




function renderExclusionList() {
  const ul = document.getElementById("exclusionListDisplay");
  ul.innerHTML = "";
  exclusionList.forEach((item, index) => {
    const li = document.createElement("li");
    li.textContent = item;
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "√ó";
    removeBtn.style.marginLeft = "10px";
    removeBtn.onclick = () => {
      exclusionList.splice(index, 1);
      db.collection("settings").doc("exclusionList").set({ items: exclusionList });
      renderExclusionList();
    };
    li.appendChild(removeBtn);
    ul.appendChild(li);
  });
}


function addToExclusionSidebar() {
  const input = document.getElementById("newExclusionSidebarInput");
  const value = input.value.trim();
  if (!value) return;

  const normalized = normalizeIngredient(value);
  if (!exclusionList.includes(normalized)) {
    exclusionList.push(normalized);
    db.collection("settings").doc("exclusionList").set({ items: exclusionList });
    renderExclusionList(); // or renderSidebarList() if you have a separate one
  }

  input.value = "";
}



function updateCategory(itemName, newCategory) {
  const lowerName = itemName.toLowerCase().trim();
  customCategoryMap[lowerName] = newCategory;
  db.collection("settings").doc("customCategoryMap").set(customCategoryMap);

  // Rebuild categorized list and re-render
  const categorized = {};
  groceryList.forEach(item => {
    const category = categorizeItem(item.name);
    if (!categorized[category]) categorized[category] = [];
    categorized[category].push(item);
  });
  window.categorized = categorized;
  renderGroceryList();
}

function updateConcatenatedItem(index, value) {
  const parts = value.trim().split(/\s+/);
  const qty = parseFloat(parts[0]);
  const unit = parts[1] || "";
  const name = parts.slice(2).join(" ");
  if (!isNaN(qty) && name) {
    groceryList[index].qty = qty;
    groceryList[index].unit = unit;
    groceryList[index].name = name;
  }
}



function updateItem(index, field, value) {
  groceryList[index][field] = value;
}

function toggleStrike(checkbox) {
  checkbox.parentElement.classList.toggle("strikethrough", checkbox.checked);
}


function clearGroceryList() {
  groceryList = [];
  document.getElementById("groceryList").innerHTML = "";
}

function renderGallery() {
  const query = document.getElementById("searchInput").value.toLowerCase();
  const container = document.getElementById("gallery");
  container.innerHTML = "";

  recipes.filter(r => r.name.toLowerCase().includes(query)).forEach(r => {
    const card = document.createElement("div");
    card.className = "planner-cell";
    card.style.display = "flex";
    card.style.flexDirection = "column";
    card.style.alignItems = "center";

    const img = document.createElement("img");
    img.src = r.image;
    img.className = "planner-thumb";
img.onclick = () => showRecipeDetail(r);
    card.appendChild(img);

    const title = document.createElement("strong");
    title.textContent = r.name;
    card.appendChild(title);

    const desc = document.createElement("em");
    desc.textContent = r.description;
    card.appendChild(desc);

const time = document.createElement("div");
time.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stopwatch" viewBox="0 0 16 16" style="margin-right: 6px; vertical-align: middle;">
    <path d="M8.5 5.6a.5.5 0 1 0-1 0v2.9h-3a.5.5 0 0 0 0 1H8a.5.5 0 0 0 .5-.5z"/>
    <path d="M6.5 1A.5.5 0 0 1 7 .5h2a.5.5 0 0 1 0 1v.57c1.36.196 2.594.78 3.584 1.64l.012-.013.354-.354-.354-.353a.5.5 0 0 1 .707-.708l1.414 1.415a.5.5 0 1 1-.707.707l-.353-.354-.354.354-.013.012A7 7 0 1 1 7 2.071V1.5a.5.5 0 0 1-.5-.5M8 3a6 6 0 1 0 .001 12A6 6 0 0 0 8 3"/>
  </svg>
  <span style="vertical-align: middle;">${r.cookTime} min</span>
`;
card.appendChild(time);


const editBtn = document.createElement("button");
editBtn.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
  </svg>
`;

    editBtn.style.marginTop = "8px";
    editBtn.style.padding = "4px 10px";
    editBtn.style.borderRadius = "4px";
    editBtn.style.border = "none";

    editBtn.style.cursor = "pointer";
    editBtn.onclick = () => loadRecipeForEditing(r);

const deleteBtn = document.createElement("button");
deleteBtn.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16" style="margin-right: 6px;">
    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
  </svg>
`;
deleteBtn.style.marginTop = "4px";
deleteBtn.style.padding = "4px 10px";
deleteBtn.style.borderRadius = "4px";
deleteBtn.style.border = "none";
deleteBtn.style.cursor = "pointer";
deleteBtn.onclick = () => {
  if (confirm(`Delete recipe "${r.name}"?`)) {
    const index = recipes.findIndex(rec => rec.name === r.name);
    if (index !== -1) {
const recipeName = r.name;
db.collection("recipes").doc(recipeName).delete().then(() => {
  recipes.splice(index, 1);
  renderGallery();
});

    }
  }
};
const buttonRow = document.createElement("div");
buttonRow.style.display = "flex";
buttonRow.style.justifyContent = "center";
buttonRow.style.gap = "10px";
buttonRow.style.marginTop = "10px";

buttonRow.appendChild(editBtn);
buttonRow.appendChild(deleteBtn);
card.appendChild(buttonRow);


    container.appendChild(card);
  });
}

function saveNewRecipe() {
  const name = document.getElementById("newRecipeName").value.trim();
  const description = document.getElementById("newRecipeDesc").value.trim();
  const cookTime = parseInt(document.getElementById("newRecipeTime").value);
  const servingSize = parseInt(document.getElementById("newRecipeServings").value, 10);

  const season = document.getElementById("newRecipeSeason").value;
  const imageInput = document.getElementById("newRecipeImage").value.trim();
  const image = imageInput || "https://developers.elementor.com/docs/assets/img/elementor-placeholder-image.png";
  const instructions = document.getElementById("newRecipeInstructions").value.split("\n").filter(Boolean);
  const notes = document.getElementById("newRecipeNotes").value.split("\n").filter(Boolean);

  const ingredientEls = document.querySelectorAll("#ingredientList > .ingredient-row");
  const ingredients = Array.from(ingredientEls).map(row => {
    const rawName = row.querySelector(".ingredient-name").value;
    const name = normalizeIngredient(rawName);
    const qty = parseFloat(row.querySelector(".ingredient-qty").value);
    const unit = row.querySelector(".ingredient-unit").value.trim();
    return { name, qty, unit };
  }).filter(i => i.name && !isNaN(i.qty));

  if (!name || !description || !season || isNaN(cookTime) || ingredients.length === 0) {
    alert("Please fill out all required fields and add at least one valid ingredient.");
    return;
  }

  const newRecipe = {
    name,
    description,
    cookTime,
    servingSize,
    season,
    ingredients,
    instructions,
    notes,
    image
  };

  // üõ†Ô∏è Check if editing an existing recipe
  const editingName = document.getElementById("addRecipePage").dataset.editing;
  if (editingName) {
    const index = recipes.findIndex(r => r.name === editingName);
    if (index !== -1) recipes.splice(index, 1); // Remove old version
    delete document.getElementById("addRecipePage").dataset.editing;
  }

  recipes.push(newRecipe);

  db.collection("recipes").doc(newRecipe.name).set(newRecipe).then(() => {
    renderPlanner();
    renderGallery();
    alert("Recipe saved!");
    showPage("plannerPage");
  });
}
function loadRecipeForEditing(recipe) {
  showPage("addRecipePage");
  document.getElementById("newRecipeName").value = recipe.name;
  document.getElementById("newRecipeDesc").value = recipe.description;
  document.getElementById("newRecipeTime").value = recipe.cookTime;
  document.getElementById("newRecipeSeason").value = recipe.season;
  document.getElementById("newRecipeImage").value = recipe.image;

  const container = document.getElementById("ingredientList");
  container.innerHTML = "";
  recipe.ingredients.forEach(({ name, qty, unit }) => {
    const row = document.createElement("div");
    row.className = "ingredient-row";
    row.innerHTML = `
      <input value="${name}" class="ingredient-name" style="width:160px;" />
      <input type="number" value="${qty}" class="ingredient-qty" style="width:60px;" />
      <input value="${unit}" class="ingredient-unit" style="width:80px;" />
    `;
    container.appendChild(row);
  });

  document.getElementById("newRecipeInstructions").value = recipe.instructions.join("\n");
  document.getElementById("newRecipeNotes").value = recipe.notes.join("\n");

  document.getElementById("addRecipePage").dataset.editing = recipe.name;
}
function editRecipe() {
  const recipeName = document.getElementById("recipeDetailHeader").textContent;
  const recipe = recipes.find(r => r.name === recipeName);
  if (recipe) loadRecipeForEditing(recipe);
}

function startNewRecipe() {
  showPage("addRecipePage");

  // Clear all fields
  document.getElementById("newRecipeName").value = "";
  document.getElementById("newRecipeDesc").value = "";
  document.getElementById("newRecipeTime").value = "";
  document.getElementById("newRecipeSeason").value = "Spring/Summer";
  document.getElementById("newRecipeImage").value = "";
  document.getElementById("newRecipeInstructions").value = "";
  document.getElementById("newRecipeNotes").value = "";

  // Clear ingredients
  const container = document.getElementById("ingredientList");
  container.innerHTML = "";
  addIngredientRow(); // Start with one empty row

  // Clear editing flag
  delete document.getElementById("addRecipePage").dataset.editing;
}
function categorizeItem(name) {
  const lower = name.toLowerCase().trim();

  // Check custom overrides first
  if (customCategoryMap[lower]) return customCategoryMap[lower];

  // Fallback to default keyword matching
  for (const keyword in categoryMap) {
    if (lower.includes(keyword)) return categoryMap[keyword];
  }

  return "Other";
}
function toggleCategoryDropdown() {
  showCategoryDropdown = !showCategoryDropdown;
  renderGroceryList();
}

function populateRecipeForm(data) {
  showPage("addRecipePage");

  document.getElementById("newRecipeName").value = data.name || "";
document.getElementById("newRecipeServings").value = data.servings || "";
  document.getElementById("newRecipeDesc").value = data.description || "";
  document.getElementById("newRecipeTime").value = data.cookTime || 0;
  document.getElementById("newRecipeImage").value = data.image || "";
  document.getElementById("newRecipeSeason").value = "Spring/Summer"; // default or infer later

  const container = document.getElementById("ingredientList");
  container.innerHTML = "";
  (data.ingredients || []).forEach(({ name, qty, unit }) => {
    const row = document.createElement("div");
    row.className = "ingredient-row";
    row.innerHTML = `
      <input value="${name}" class="ingredient-name" style="width:160px;" />
      <input type="number" value="${qty}" class="ingredient-qty" style="width:60px;" />
      <input value="${unit}" class="ingredient-unit" style="width:80px;" />
    `;
    container.appendChild(row);
  });

  document.getElementById("newRecipeInstructions").value = (data.instructions || []).join("\n");
  document.getElementById("newRecipeNotes").value = (data.notes || []).join("\n");
}
function addNoteToDetail() {
  const input = document.getElementById("newNoteInput");
  const noteText = input.value.trim();
  if (!noteText) return;

  const li = document.createElement("li");
  li.textContent = noteText;
  document.getElementById("notesList").appendChild(li);
  input.value = "";
}
function confirmDeleteRecipe() {
  const recipeName = document.getElementById("detailImage").alt;
  if (!recipeName) {
    alert("No recipe loaded.");
    return;
  }

  const confirmed = confirm(`Are you sure you want to delete "${recipeName}"?`);
  if (!confirmed) {
    showPage("recipeDetailPage");
    return;
  }

  const index = recipes.findIndex(r => r.name === recipeName);
  if (index !== -1) {
db.collection("recipes").doc(recipeName).delete().then(() => {
  recipes.splice(index, 1);
  renderPlanner();
  renderGallery();
  alert(`"${recipeName}" deleted.`);
  showPage("plannerPage");
});


    // üîÑ Refresh planner and gallery
    renderPlanner();
    renderGallery();

    alert(`"${recipeName}" deleted.`);
    showPage("plannerPage");
  }
}
async function fetchRecipe() {
  const url = document.getElementById("recipeUrlInput").value.trim();
  if (!url || !url.startsWith("http")) {
    alert("Please enter a valid recipe URL");
    return;
  }

const apiKey = import.meta.env.VITE_SPOONACULAR_API_KEY;
const endpoint = `https://api.spoonacular.com/recipes/extract?url=${encodeURIComponent(url)}&apiKey=${apiKey}`;


  try {
    const res = await fetch(endpoint);
    if (res.status === 402 || res.status === 429) {
      alert("API limit reached. Try again tomorrow or upgrade your Spoonacular plan.");
      return;
    }

    const data = await res.json();
    if (!data.title) {
      alert("Could not extract recipe from this URL. Try another one.");
      return;
    }

    const ingredients = (data.extendedIngredients || []).map(ing => ({
      name: normalizeIngredient(ing.name),
      qty: ing.amount,
      unit: ing.unit
    }));

    const instructions = data.analyzedInstructions?.[0]?.steps?.map(s => s.step) || [];

    const newRecipe = {
      name: data.title,
      description: data.summary || "",
      cookTime: data.readyInMinutes || 0,
      servingSize: data.servings || "",
      image: data.image || fallbackImage,
      ingredients,
      instructions,
      notes: []
    };

    recipes.push(newRecipe);
    await db.collection("recipes").doc(newRecipe.name).set(newRecipe); // ‚úÖ Now inside async block

    populateRecipeForm(newRecipe);
  } catch (err) {
    console.error("Spoonacular API error:", err);
    alert("Failed to fetch recipe. Please try again later.");
  }
}


function clearRecipe(dayId) {
  const clearBtn = document.getElementById(`${dayId}-clearBtn`);
if (clearBtn) clearBtn.style.display = "none";
  const input = document.getElementById(`${dayId}-main`);
  if (input) input.value = "";

  const imgEl = document.getElementById(`${dayId}-img`);
  if (imgEl) {
    imgEl.src = fallbackImage;
    imgEl.alt = "Add Recipe";
  }

  const season = document.getElementById("seasonSelect").value;
  if (!plannerSelections[season]) plannerSelections[season] = {};
  plannerSelections[season][dayId] = { main: "", sides: [], week: parseInt(document.getElementById("weekSelect").value) };
  db.collection("plannerSelections").doc("default").set(plannerSelections);

}
function updateClearButtons() {
  const mode = document.getElementById("plannerMode").value;
  const season = document.getElementById("seasonSelect").value;
  const week = parseInt(document.getElementById("weekSelect").value);

  if (mode === "week") {
    for (let d = 1; d <= 7; d++) {
      const dayId = `W${week}D${d}`;
      const input = document.getElementById(`${dayId}-main`);
      const clearBtn = document.getElementById(`${dayId}-clearBtn`);
      if (input && clearBtn) {
        clearBtn.style.display = input.value ? "inline-block" : "none";
      }
    }
  }
}
function readableUnit(qty, baseUnit) {
  if (baseUnit === "tsp") {
    if (qty >= 48) return { qty: qty / 48, unit: "cup" };
    if (qty >= 6) return { qty: qty / 6, unit: "oz" };
    if (qty >= 3) return { qty: qty / 3, unit: "tbsp" };
  }
  return { qty, unit: baseUnit };
}
function renderExclusionList(target = "exclusionListDisplay") {
  const ul = document.getElementById(target);
  ul.innerHTML = "";
  exclusionList.forEach((item, index) => {
    const li = document.createElement("li");
    li.textContent = item;
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "√ó";
    removeBtn.style.marginLeft = "10px";
    removeBtn.onclick = () => {
      exclusionList.splice(index, 1);
      db.collection("settings").doc("exclusionList").set({ items: exclusionList });
      renderExclusionList(target);
    };
    li.appendChild(removeBtn);
    ul.appendChild(li);
  });
}
function addToExclusionList() {
  const input = document.getElementById("newExclusionInput");
  const value = normalizeIngredient(input.value);
  if (value && !exclusionList.includes(value)) {
    exclusionList.push(value);
    db.collection("settings").doc("exclusionList").set({ items: exclusionList });
    renderExclusionList();
    input.value = "";
  }
}


function toggleExclusionSidebar() {
  const sidebar = document.getElementById("exclusionSidebar");
  const isVisible = sidebar.style.display === "block";
  sidebar.style.display = isVisible ? "none" : "block";
  if (!isVisible) renderExclusionSidebar();
}

function renderExclusionSidebar() {
  const ul = document.getElementById("exclusionListSidebar");
  ul.innerHTML = "";

  exclusionList.forEach((item, index) => {
    const li = document.createElement("li");
    li.textContent = item;

    const removeBtn = document.createElement("button");
    removeBtn.textContent = "√ó";
    removeBtn.style.marginLeft = "10px";
    removeBtn.onclick = () => {
      exclusionList.splice(index, 1);
      db.collection("settings").doc("exclusionList").set({ items: exclusionList });
      renderExclusionSidebar();
    };

    li.appendChild(removeBtn);
    ul.appendChild(li);
  });
}



function addToExclusionSidebar() {
  const input = document.getElementById("newExclusionSidebarInput");
  const value = normalizeIngredient(input.value);
  if (value && !exclusionList.includes(value)) {
    exclusionList.push(value);
    db.collection("settings").doc("exclusionList").set({ items: exclusionList });
    renderExclusionSidebar();
    input.value = "";
  }
}


function renderConversionTable() {
  const tbody = document.getElementById("conversionTableBody");
  tbody.innerHTML = "";

  Object.entries(unitConversion).forEach(([from, { to, factor }]) => {
    const row = document.createElement("tr");

    const fromCell = document.createElement("td");
    fromCell.textContent = from;

    const toCell = document.createElement("td");
    toCell.textContent = to;

    const factorCell = document.createElement("td");
    factorCell.textContent = factor;

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "√ó";
    deleteBtn.style.marginLeft = "10px";
    deleteBtn.onclick = () => {
      delete unitConversion[from];
      db.collection("settings").doc("unitConversion").set(unitConversion);
      renderConversionTable();
    };

    const actionCell = document.createElement("td");
    actionCell.appendChild(deleteBtn);

    row.appendChild(fromCell);
    row.appendChild(toCell);
    row.appendChild(factorCell);
    row.appendChild(actionCell);
    tbody.appendChild(row);
  }); // ‚Üê this closes forEach
} // ‚Üê this closes renderConversionTable


function addConversion() {
  const from = document.getElementById("newFromUnit").value.trim();
  const to = document.getElementById("newToUnit").value.trim();
  const factor = parseFloat(document.getElementById("newFactor").value);

  if (!from || !to || isNaN(factor) || factor <= 0) {
    alert("Please enter valid conversion values.");
    return;
  }

  unitConversion[from] = { to, factor };
  db.collection("settings").doc("unitConversion").set(unitConversion);
  renderConversionTable();

  document.getElementById("newFromUnit").value = "";
  document.getElementById("newToUnit").value = "";
  document.getElementById("newFactor").value = "";
}





// Initial render
renderPlanner();
renderGallery();
</script>
</body>
</html>

         
